<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">

<style>
body {
  font-family: 'Roboto', sans-serif;
  background:#f4f4f4;
  margin:0;
}

/* NAVBAR */
.navbar {
  height:100%;
  width:250px;
  position:fixed;
  top:0;
  left:-250px;
  background:#333;
  transition:0.3s;
  padding-top:60px;
  z-index:1000;
}
.navbar a {
  color:white;
  padding:12px 20px;
  display:block;
  text-decoration:none;
}
.navbar a:hover { background:red }

/* HAMBURGER */
.hamburger {
  position:fixed;
  top:20px;
  left:20px;
  font-size:30px;
  color:white;
  cursor:pointer;
  z-index:1100;
}

/* LOGO */
.logo-container {
  display:flex;
  justify-content:center;
  margin-top:30px;
}
.logo {
  width:120px;
}

/* CONTAINER */
.container {
  width:60%;
  margin:120px auto;
  background:rgba(0,0,0,0.2);
  padding:20px;
  border-radius:6px;
  color:white;
}

/* MEMBERSHIP */
.membership-status {
  padding:10px;
  margin:15px 0;
  text-align:center;
  border-radius:4px;
}
.active { background:#2e7d32 }
.expired { background:#c62828 }

/* FORM */
form {
  background:rgba(0,0,0,0.2);
  padding:20px;
  border-radius:6px;
}
input, select {
  width:100%;
  padding:8px;
  margin-bottom:10px;
}
.btn {
  padding:10px 15px;
  border:none;
  background:red;
  color:white;
  cursor:pointer;
}
.btn-secondary {
  background:#2196F3;
}

/* MOBILE */
@media(max-width:768px){
  .container { width:90% }
}

/* ===== PROFILE LAYOUT FIX (SAFE OVERRIDES) ===== */

/* Keep same background, just fix spacing */
.container {
    width: 60%;
    margin: 40px auto 40px auto;   /* BELOW LOGO */
    padding: 20px;
}

/* Logo spacing */
.logo-container {
    margin-top: 80px;
    margin-bottom: 20px;
}

/* Prevent content going behind navbar */
body {
    margin-top: 0;
}

/* Mobile & Tablet */
@media (max-width: 1024px) {
    .container {
        width: 80%;
    }
}

@media (max-width: 768px) {
    .container {
        width: 92%;
        margin-top: 30px;
    }

    .logo-container {
        margin-top: 60px;
    }

    .membership-status {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 15px;
    }

    h1 {
        font-size: 24px;
    }

    input, select {
        font-size: 14px;
    }
}

</style>
</head>

<body>

<div class="hamburger" onclick="toggleNavbar()">â˜°</div>

<div class="navbar" id="navbar">
  <h3 id="navUser" style="color:white;text-align:center"></h3>
  <a href="home.html">Home</a>
  <a href="exercise.html">Exercise</a>
  <a href="profile.html">Profile</a>
  <a href="diet.html">Diet</a>
  <a href="membership.html">Membership</a>
</div>

<div class="logo-container">
  <img src="images/logo1.png" class="logo">
</div>

<div class="container">
<h1>Profile</h1>

<!-- USER INFO -->
<p><strong>Full Name:</strong> <span id="fullnameDisplay"></span></p>
<p><strong>Username:</strong> <span id="usernameDisplay"></span></p>
<p><strong>Email:</strong> <span id="emailDisplay"></span></p>

<!-- MEMBERSHIP -->
<div id="membershipStatus" class="membership-status"></div>
<p><strong>Membership Type:</strong> <span id="membershipType"></span></p>

<h3>Edit Profile</h3>

<form onsubmit="saveProfile(event)">
  <label>Address</label>
  <input id="address">

  <label>Phone</label>
  <input id="phone">

  <label>Gender</label>
  <select id="gender">
    <option>Male</option>
    <option>Female</option>
    <option>Other</option>
  </select>

  <label>Height (cm)</label>
  <input type="number" id="height">

  <label>Weight (kg)</label>
  <input type="number" id="weight">

  <button class="btn">Save Profile</button>
  <button type="button" class="btn btn-secondary" onclick="updateProfile()">Update Profile</button>
</form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE SETUP ================= */
const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

const supabase = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= NAVBAR ================= */
function toggleNavbar(){
  const nav=document.getElementById("navbar");
  nav.style.left = nav.style.left==="0px" ? "-250px" : "0px";
}

/* ================= AUTH USER ================= */
const userSession = JSON.parse(localStorage.getItem("user"));
if (!userSession) {
  window.location.href = "index.html";
}

const uid = userSession.uid;

/* ================= LOAD USER ================= */
async function loadUser() {
  const { data, error } = await supabase
    .from("users")
    .select("fullname, username, email")
    .eq("uid", uid)
    .single();

  if (error) return alert(error.message);

  fullnameDisplay.innerText = data.fullname;
  usernameDisplay.innerText = data.username;
  emailDisplay.innerText = data.email;
  navUser.innerText = `Welcome, ${data.username}!`;
}

/* ================= MEMBERSHIP ================= */
async function loadMembership() {
  const { data } = await supabase
    .from("memberships")
    .select("membership_status, membership_type, expiry_date")
    .eq("uid", uid)
    .single();

  const statusBox = document.getElementById("membershipStatus");

  if (!data) {
    statusBox.innerText = "No active membership found.";
    statusBox.classList.add("expired");
    membershipType.innerText = "-";
    return;
  }

  const expired = new Date(data.expiry_date) < new Date();
  const status = expired ? "Expired" : "Active";

  statusBox.innerText =
    status === "Active"
      ? "Your membership is active."
      : "Your membership has expired.";

  statusBox.classList.add(status === "Active" ? "active" : "expired");
  membershipType.innerText = data.membership_type;
}

/* ================= PROFILE ================= */
async function loadProfile() {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("uid", uid)
    .single();

  if (!data) return;

  address.value = data.address || "";
  phone.value = data.phone_number || "";
  gender.value = data.gender || "Male";
  height.value = data.height || "";
  weight.value = data.weight || "";
}

/* ================= SAVE PROFILE ================= */
async function saveProfile(e){
  e.preventDefault();

  const payload = {
    uid,
    address: address.value,
    phone_number: phone.value,
    gender: gender.value,
    height: height.value,
    weight: weight.value,
    bmi: height.value && weight.value
      ? (weight.value / ((height.value/100) ** 2)).toFixed(1)
      : null
  };

  const { error } = await supabase
    .from("profiles")
    .insert(payload);

  if (error && !error.message.includes("duplicate")) {
    alert(error.message);
    return;
  }

  alert("Profile saved successfully!");
}

/* ================= UPDATE PROFILE ================= */
async function updateProfile(){
  const payload = {
    address: address.value,
    phone_number: phone.value,
    gender: gender.value,
    height: height.value,
    weight: weight.value,
    bmi: height.value && weight.value
      ? (weight.value / ((height.value/100) ** 2)).toFixed(1)
      : null
  };

  const { error } = await supabase
    .from("profiles")
    .update(payload)
    .eq("uid", uid);

  if (error) {
    alert(error.message);
    return;
  }

  alert("Profile updated successfully!");
}

/* ================= INIT ================= */
loadUser();
loadMembership();
loadProfile();
</script>
</body>
</html>


